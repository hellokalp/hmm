<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üîÆ The Portal ‚Äî Classified Mission</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&family=Pacifico&display=swap" rel="stylesheet" />
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
    body{font-family:'Space Mono',monospace;background:#07060e;color:#c0c0e0;overflow-x:hidden;min-height:100dvh;user-select:none;-webkit-user-select:none}
    #particles{position:fixed;inset:0;z-index:0;pointer-events:none}

    /* screens */
    .screen{position:relative;z-index:2;display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;padding:1.5rem 1.2rem;text-align:center}
    .screen.active{display:flex;animation:fadeUp .7s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}

    /* portal */
    .ring{--sz:min(52vw,200px);width:var(--sz);height:var(--sz);border-radius:50%;border:3px solid rgba(120,80,255,.5);box-shadow:0 0 45px rgba(120,80,255,.4),inset 0 0 45px rgba(120,80,255,.25);display:flex;align-items:center;justify-content:center;animation:pulse 3s ease-in-out infinite;margin-bottom:1.6rem;position:relative;flex-shrink:0}
    .ring::before{content:'';position:absolute;inset:-7px;border-radius:50%;border:2px dashed rgba(200,140,255,.18);animation:spin 14s linear infinite}
    @keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 45px rgba(120,80,255,.4),inset 0 0 45px rgba(120,80,255,.25)}50%{transform:scale(1.05);box-shadow:0 0 75px rgba(120,80,255,.55),inset 0 0 65px rgba(120,80,255,.32)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .ring .ico{font-size:clamp(2.8rem,10vw,4rem);animation:bob 3.5s ease-in-out infinite}

    h1.title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:clamp(1.3rem,5.5vw,2.4rem);letter-spacing:2px;background:linear-gradient(90deg,#7850ff,#c084fc,#7850ff);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:shimmer 5s linear infinite;margin-bottom:.6rem;line-height:1.3}
    @keyframes shimmer{to{background-position:200% 0}}
    .sub{max-width:500px;width:100%;font-size:clamp(.78rem,2.8vw,.9rem);line-height:1.7;opacity:.7;margin-bottom:1.8rem;padding:0 .3rem}
    .btn{font-family:'Orbitron',sans-serif;font-weight:700;font-size:clamp(.72rem,2.6vw,.85rem);padding:13px 36px;border:2px solid #7850ff;background:transparent;color:#c084fc;border-radius:50px;cursor:pointer;letter-spacing:2px;transition:all .3s}
    .btn:hover,.btn:active{background:rgba(120,80,255,.15);box-shadow:0 0 28px rgba(120,80,255,.4);transform:scale(1.04)}
    .badge{display:inline-block;font-family:'Orbitron',sans-serif;font-size:clamp(.5rem,2vw,.6rem);letter-spacing:3px;padding:5px 14px;border-radius:20px;background:rgba(120,80,255,.12);border:1px solid rgba(120,80,255,.25);color:#b090e0;margin-bottom:1.2rem}

    /* card */
    .card{background:rgba(16,12,35,.78);backdrop-filter:blur(8px);border:1px solid rgba(120,80,255,.18);border-radius:18px;padding:clamp(1.2rem,4vw,2rem);width:100%;max-width:520px;transition:border-color .4s,box-shadow .4s}
    .card:hover{border-color:rgba(120,80,255,.3)}
    .card h2{font-family:'Orbitron',sans-serif;font-size:clamp(.82rem,3vw,1rem);color:#c084fc;margin-bottom:.4rem;display:flex;align-items:center;gap:8px;justify-content:center}
    .card p{font-size:clamp(.76rem,2.6vw,.84rem);line-height:1.65;opacity:.7;margin-bottom:1rem}
    .card.solved{border-color:rgba(50,220,120,.4);box-shadow:0 0 25px rgba(50,220,120,.12)}
    .solved-tag{display:none;font-family:'Orbitron',sans-serif;font-size:clamp(.58rem,2vw,.65rem);letter-spacing:2px;color:#32dc78;margin-top:.8rem;text-align:center}
    .card.solved .solved-tag{display:block;animation:fadeUp .5s ease}

    /* toggle buttons */
    .toggle-btn{font-size:clamp(.65rem,2.2vw,.72rem);cursor:pointer;margin-bottom:.5rem;display:inline-block;transition:color .3s;padding:6px 14px;border-radius:8px;border:1px solid transparent}
    .toggle-btn.hint-btn{color:#8060b0;border-color:rgba(120,80,255,.12)}
    .toggle-btn.hint-btn:hover,.toggle-btn.hint-btn:active{color:#c084fc;border-color:rgba(120,80,255,.3)}
    .toggle-btn.sol-btn{color:#e08040;border-color:rgba(255,140,50,.15);margin-left:6px}
    .toggle-btn.sol-btn:hover,.toggle-btn.sol-btn:active{color:#ffaa50;border-color:rgba(255,140,50,.3)}
    .toggles-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:.8rem}

    /* hint box */
    .hint-box{display:none;font-size:clamp(.68rem,2.3vw,.78rem);color:#a080d0;background:rgba(120,80,255,.06);padding:12px 14px;border-radius:10px;border-left:3px solid rgba(120,80,255,.25);margin-bottom:1rem;text-align:left;line-height:1.7}
    .hint-box.show{display:block;animation:fadeUp .35s ease}

    /* solution box */
    .sol-box{display:none;width:100%;background:rgba(255,130,50,.04);border:1px solid rgba(255,130,50,.15);border-radius:12px;padding:clamp(.8rem,3vw,1.2rem);margin-bottom:1rem}
    .sol-box.show{display:block;animation:fadeUp .4s ease}
    .sol-box .sol-title{font-family:'Orbitron',sans-serif;font-size:clamp(.58rem,2vw,.68rem);color:#ff8040;letter-spacing:2px;margin-bottom:.5rem;text-align:center}
    .sol-box .sol-desc{font-size:clamp(.6rem,2vw,.68rem);color:#cc9060;text-align:center;margin-bottom:.8rem;line-height:1.5;opacity:.8}
    .sol-grid-wrap{display:flex;justify-content:center;margin-bottom:.8rem}
    .sol-grid{display:grid;gap:clamp(3px,1vw,5px)}
    .sol-cell{width:clamp(36px,11vw,48px);height:clamp(36px,11vw,48px);border-radius:clamp(6px,2vw,10px);display:flex;align-items:center;justify-content:center;font-size:clamp(.7rem,2.4vw,.88rem);font-family:'Orbitron',sans-serif;font-weight:700;border:2px solid transparent;transition:all .25s}
    .sol-cell.click-me{background:rgba(255,130,50,.18);border-color:rgba(255,130,50,.5);color:#ff8040;cursor:pointer;box-shadow:0 0 10px rgba(255,130,50,.12);animation:solPulse 1.5s ease-in-out infinite}
    @keyframes solPulse{0%,100%{box-shadow:0 0 8px rgba(255,130,50,.12)}50%{box-shadow:0 0 18px rgba(255,130,50,.25)}}
    .sol-cell.click-me:active{transform:scale(.92)}
    .sol-cell.click-me.done{background:rgba(50,220,120,.12);border-color:rgba(50,220,120,.4);color:#32dc78;pointer-events:none;box-shadow:0 0 10px rgba(50,220,120,.12);animation:none}
    .sol-cell.empty{background:rgba(120,80,255,.04);border-color:rgba(120,80,255,.08);color:rgba(120,80,255,.12)}
    .sol-cell.lit{background:rgba(120,80,255,.2);border-color:rgba(120,80,255,.25);color:rgba(180,140,255,.4)}
    .sol-auto-wrap{text-align:center;margin-top:.5rem}
    .sol-auto{font-family:'Orbitron',sans-serif;font-size:clamp(.6rem,2.1vw,.7rem);padding:10px 24px;border:1px solid rgba(255,130,50,.3);background:rgba(255,130,50,.1);color:#ff8040;border-radius:10px;cursor:pointer;transition:all .3s;letter-spacing:1px}
    .sol-auto:hover,.sol-auto:active{background:rgba(255,130,50,.2);box-shadow:0 0 18px rgba(255,130,50,.2);transform:scale(1.03)}

    /* lights out grid */
    .lights-grid{display:grid;gap:clamp(5px,1.5vw,8px);margin:0 auto 1rem}
    .lights-cell{aspect-ratio:1;border-radius:clamp(8px,2.5vw,14px);cursor:pointer;transition:all .18s;border:2px solid transparent;display:flex;align-items:center;justify-content:center}
    .lights-cell.on{background:rgba(120,80,255,.55);border-color:rgba(120,80,255,.6);box-shadow:0 0 16px rgba(120,80,255,.35)}
    .lights-cell.off{background:rgba(20,15,35,.6);border-color:rgba(60,40,100,.18)}
    .lights-cell:active{transform:scale(.92)}
    .lights-cell.pop{animation:lpop .25s ease}
    @keyframes lpop{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
    .lights-info{display:flex;justify-content:center;gap:clamp(1rem,4vw,2rem);margin-bottom:.8rem;flex-wrap:wrap}
    .lights-info .stat{font-size:clamp(.68rem,2.3vw,.78rem);color:#8060b0;display:flex;align-items:center;gap:6px}
    .lights-info .stat span{color:#c084fc;font-family:'Orbitron',sans-serif;font-size:clamp(.72rem,2.5vw,.85rem)}
    .lights-reset{font-family:'Space Mono',monospace;font-size:clamp(.62rem,2.1vw,.7rem);color:#6050a0;background:none;border:1px solid rgba(120,80,255,.15);padding:7px 18px;border-radius:8px;cursor:pointer;margin-top:.6rem;transition:all .3s}
    .lights-reset:hover,.lights-reset:active{color:#c084fc;border-color:rgba(120,80,255,.35)}

    /* final portal */
    .mega-ring{--sz:min(65vw,260px);width:var(--sz);height:var(--sz);border-radius:50%;cursor:pointer;border:3px solid rgba(120,80,255,.5);box-shadow:0 0 60px rgba(120,80,255,.4),inset 0 0 60px rgba(120,80,255,.28);display:flex;align-items:center;justify-content:center;animation:pulse 2s ease-in-out infinite;margin-bottom:1.6rem;position:relative;overflow:hidden;flex-shrink:0}
    .mega-ring::before{content:'';position:absolute;width:160%;height:160%;background:conic-gradient(rgba(120,80,255,.22),transparent,rgba(200,130,255,.22),transparent,rgba(120,80,255,.22));animation:spin 5s linear infinite}
    .mega-ring .inner{position:relative;z-index:1;font-size:clamp(2.5rem,10vw,4rem);animation:bob 2.5s ease-in-out infinite}
    .mega-ring:hover,.mega-ring:active{box-shadow:0 0 90px rgba(120,80,255,.55),inset 0 0 80px rgba(120,80,255,.38)}
    .portal-hint{font-size:clamp(.65rem,2.2vw,.76rem);opacity:.4;animation:bob 4s ease-in-out infinite}

    /* celebration */
    .cele-overlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;overflow:hidden}
    .cele-overlay.active{display:flex;animation:celeIn 1s ease}
    @keyframes celeIn{from{opacity:0}to{opacity:1}}
    .cele-bg{position:absolute;inset:0;z-index:0;background:radial-gradient(ellipse at center,rgba(110,30,200,.95),rgba(15,4,50,.98) 65%,rgba(4,0,18,1))}
    .cele-content{position:relative;z-index:2;text-align:center;padding:1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:560px;width:100%}
    .cele-surprise{font-family:'Orbitron',sans-serif;font-size:clamp(.75rem,3vw,1.2rem);letter-spacing:clamp(4px,1.5vw,8px);color:#c084fc;margin-bottom:.8rem;opacity:0;animation:revTxt 1s ease .4s forwards}
    @keyframes revTxt{from{opacity:0;transform:translateY(15px);letter-spacing:15px}to{opacity:1;transform:translateY(0);letter-spacing:6px}}
    .cele-cake{font-size:clamp(3rem,12vw,6.5rem);animation:bob 2s ease-in-out infinite;margin-bottom:.8rem}
    .cele-msg{font-family:'Pacifico',cursive;font-size:clamp(1.8rem,8vw,4.5rem);line-height:1.3;background:linear-gradient(135deg,#ff6bca,#ffbe30,#5bffb0,#50aaff,#d080ff);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:rainbow 4s ease infinite,popIn 1s ease .9s both;filter:drop-shadow(0 0 25px rgba(255,100,200,.3));margin-bottom:1.2rem}
    @keyframes rainbow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    @keyframes popIn{from{opacity:0;transform:scale(.4) rotate(-5deg)}60%{transform:scale(1.1) rotate(2deg)}to{opacity:1;transform:scale(1) rotate(0)}}
    .cele-note{font-family:'Space Mono',monospace;font-size:clamp(.72rem,2.5vw,.92rem);color:rgba(255,255,255,.6);max-width:440px;width:100%;margin:0 auto;line-height:1.8;opacity:0;animation:fadeUp .8s ease 1.8s forwards;padding:0 .5rem}
    #confetti{position:fixed;inset:0;z-index:9998;pointer-events:none}
    .balloon{position:fixed;bottom:-100px;font-size:clamp(1.8rem,6vw,2.8rem);z-index:10000;pointer-events:none;animation:rise linear forwards}
    @keyframes rise{to{bottom:110vh}}
    .sparkle{position:fixed;border-radius:50%;pointer-events:none;z-index:10001;animation:sparkOut 1s ease forwards}
    @keyframes sparkOut{to{opacity:0;transform:scale(0) translateY(-25px)}}

    @media(max-width:380px){.card{padding:1rem}}
  </style>
</head>
<body>

<canvas id="particles"></canvas>

<!-- ===== INTRO ===== -->
<section class="screen active" id="scrIntro">
  <div class="ring"><span class="ico">üîÆ</span></div>
  <h1 class="title">THE PORTAL AWAITS</h1>
  <p class="sub">A classified signal has been intercepted from beyond the void. One encrypted fragment must be recovered to unlock the gateway. Only the sharpest minds survive.</p>
  <button class="btn" id="btnStart">ENTER THE PORTAL</button>
</section>

<!-- ===== PUZZLE ===== -->
<section class="screen" id="scrPuzzle">
  <span class="badge">üí° Encrypted Fragment</span>
  <div class="card" id="cardPuzzle">
    <h2>üí° Lights Out Protocol</h2>
    <p>Turn <strong>ALL lights OFF</strong> to decrypt the fragment. Clicking a light toggles it <strong>and its neighbors</strong> (‚Üë‚Üì‚Üê‚Üí). Think before you tap.</p>

    <!-- Two toggle buttons side by side -->
    <div class="toggles-row">
      <div class="toggle-btn hint-btn" onclick="toggle('hintBox')">üí° Hint</div>
      <div class="toggle-btn sol-btn" onclick="toggle('solBox')">üîì Solution</div>
    </div>

    <!-- Hint Box -->
    <div class="hint-box" id="hintBox">
      <strong>Chase technique:</strong> Work top ‚Üí bottom. For each lit cell in a row, tap the cell <em>directly below</em> it. This pushes the problem downward. If the bottom row isn't clear after chasing, reset and try clicking different cells in row 1 first, then chase again.
    </div>

    <!-- Solution Box -->
    <div class="sol-box" id="solBox">
      <div class="sol-title">‚ö† SOLUTION MAP</div>
      <div class="sol-desc">Orange numbered cells = click in order (1‚Üí2‚Üí3‚Ä¶)<br>Or tap auto-solve to watch it solve itself.</div>
      <div class="sol-grid-wrap"><div class="sol-grid" id="solGrid"></div></div>
      <div class="sol-auto-wrap">
        <button class="sol-auto" id="btnAuto">‚ö° AUTO-SOLVE</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="lights-info">
      <div class="stat">Moves: <span id="moveCount">0</span></div>
      <div class="stat">Lit: <span id="litCount">0</span></div>
    </div>

    <!-- Grid -->
    <div class="lights-grid" id="lightsGrid"></div>

    <button class="lights-reset" id="resetBtn">‚Üª Reset Puzzle</button>
    <div class="solved-tag">‚úì FRAGMENT DECRYPTED ‚Äî GATEWAY UNLOCKED</div>
  </div>
</section>

<!-- ===== FINAL PORTAL ===== -->
<section class="screen" id="scrFinal">
  <span class="badge">‚ö° FRAGMENT RECOVERED</span>
  <h1 class="title" style="font-size:clamp(1.1rem,4.5vw,1.9rem)">The Gateway Is Open</h1>
  <p class="sub">The fragment is reassembled. The portal hums with raw energy. Whatever is on the other side‚Ä¶ there's no going back.</p>
  <div class="mega-ring" id="megaPortal"><span class="inner">üåÄ</span></div>
  <p class="portal-hint">Tap the portal to cross over‚Ä¶</p>
</section>

<!-- ===== CELEBRATION ===== -->
<div class="cele-overlay" id="celeOverlay">
  <div class="cele-bg"></div>
  <canvas id="confetti"></canvas>
  <div class="cele-content">
    <div class="cele-surprise">‚ú¶ SURPRISE ‚ú¶</div>
    <div class="cele-cake">üéÇ</div>
    <div class="cele-msg">Happy Birthday,<br>Bro!</div>
    <p class="cele-note">üéà The whole "classified mission" was a setup! There was never a portal ‚Äî just people who wanted to make your day unforgettable. Here's to an incredible year ahead! üéâ</p>
  </div>
</div>

<script>
/* ============ PARTICLES ============ */
const pc=document.getElementById('particles'),px=pc.getContext('2d');let pts=[];
function rP(){pc.width=innerWidth;pc.height=innerHeight}rP();addEventListener('resize',rP);
class Pt{constructor(){this.reset()}reset(){this.x=Math.random()*pc.width;this.y=Math.random()*pc.height;this.r=Math.random()*2+.3;this.dx=(Math.random()-.5)*.3;this.dy=(Math.random()-.5)*.3;this.o=Math.random()*.38+.06;this.h=255+Math.random()*40}update(){this.x+=this.dx;this.y+=this.dy;if(this.x<0||this.x>pc.width||this.y<0||this.y>pc.height)this.reset()}draw(){px.beginPath();px.arc(this.x,this.y,this.r,0,Math.PI*2);px.fillStyle=`hsla(${this.h},65%,68%,${this.o})`;px.fill()}}
for(let i=0;i<70;i++)pts.push(new Pt());
(function a(){px.clearRect(0,0,pc.width,pc.height);pts.forEach(p=>{p.update();p.draw()});requestAnimationFrame(a)})();

/* ============ NAV ============ */
function go(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');scrollTo({top:0,behavior:'smooth'})}
document.getElementById('btnStart').onclick=()=>go('scrPuzzle');
function toggle(id){document.getElementById(id).classList.toggle('show')}

/* ============ GAUSSIAN SOLVER (GF2) ============ */
function solveBoard(board,N){
  const sz=N*N;
  let mat=[];
  for(let i=0;i<sz;i++){
    let row=new Uint8Array(sz+1);
    const r=Math.floor(i/N),c=i%N;
    row[i]=1;
    if(r>0)row[i-N]=1;
    if(r<N-1)row[i+N]=1;
    if(c>0)row[i-1]=1;
    if(c<N-1)row[i+1]=1;
    row[sz]=board[i]?1:0;
    mat.push(row);
  }
  let pivotRow=0;
  for(let col=0;col<sz&&pivotRow<sz;col++){
    let found=-1;
    for(let r=pivotRow;r<sz;r++){if(mat[r][col]){found=r;break}}
    if(found===-1)continue;
    [mat[pivotRow],mat[found]]=[mat[found],mat[pivotRow]];
    for(let r=0;r<sz;r++){
      if(r!==pivotRow&&mat[r][col]){
        for(let k=col;k<=sz;k++)mat[r][k]^=mat[pivotRow][k];
      }
    }
    pivotRow++;
  }
  let clicks=[];
  for(let i=0;i<sz;i++){if(mat[i][sz])clicks.push(i)}
  return clicks;
}

/* ============ LIGHTS OUT (5√ó5, FIXED SOLVABLE BOARD) ============ */
const SIZE=5;
const grid=document.getElementById('lightsGrid');
const cellSz='clamp(48px,14vw,64px)';
grid.style.gridTemplateColumns=`repeat(${SIZE},${cellSz})`;
grid.style.justifyContent='center';

let state=[],moves=0,puzzleSolved=false;
let initialState=[];
let solution=[];

/*
  FIXED starting board ‚Äî guaranteed solvable, 12 lights on, needs ~12 moves.
  This is the SAME board every time ‚Äî so solution always works.

  Board:
    Row 0:  ‚óè ‚óã ‚óè ‚óè ‚óã
    Row 1:  ‚óè ‚óè ‚óã ‚óã ‚óè
    Row 2:  ‚óã ‚óè ‚óè ‚óè ‚óã
    Row 3:  ‚óè ‚óã ‚óã ‚óã ‚óè
    Row 4:  ‚óã ‚óè ‚óè ‚óã ‚óã

  Generated by applying clicks at: [0,2,5,8,11,14,17,19,22,24,6,13]
*/
const FIXED_BOARD=[
  true, false, true, true, false,
  true, true,  false,false,true,
  false,true,  true, true, false,
  true, false, false,false,true,
  false,true,  true, false,false
];

function initBoard(){
  state=[...FIXED_BOARD];
  initialState=[...FIXED_BOARD];
  moves=0;puzzleSolved=false;
  document.getElementById('moveCount').textContent=0;
  document.getElementById('cardPuzzle').classList.remove('solved');
  solution=solveBoard([...state],SIZE);
  updateLitCount();
  render();
  renderSolution();
}

function resetBoard(){
  state=[...initialState];
  moves=0;puzzleSolved=false;
  document.getElementById('moveCount').textContent=0;
  document.getElementById('cardPuzzle').classList.remove('solved');
  solution=solveBoard([...state],SIZE);
  updateLitCount();
  render();
  renderSolution();
  // also reset solution cell done states
  document.querySelectorAll('.sol-cell.done').forEach(c=>c.classList.remove('done'));
}

function applyToggle(idx,silent){
  const r=Math.floor(idx/SIZE),c=idx%SIZE;
  state[idx]=!state[idx];
  if(r>0)state[idx-SIZE]=!state[idx-SIZE];
  if(r<SIZE-1)state[idx+SIZE]=!state[idx+SIZE];
  if(c>0)state[idx-1]=!state[idx-1];
  if(c<SIZE-1)state[idx+1]=!state[idx+1];
  if(!silent){moves++;document.getElementById('moveCount').textContent=moves;updateLitCount()}
}

function updateLitCount(){document.getElementById('litCount').textContent=state.filter(Boolean).length}

function render(){
  grid.innerHTML='';
  state.forEach((on,i)=>{
    const cell=document.createElement('div');
    cell.className='lights-cell '+(on?'on':'off');
    cell.addEventListener('click',()=>handleClick(i));
    grid.appendChild(cell);
  });
}

function handleClick(i){
  if(puzzleSolved)return;
  applyToggle(i,false);
  render();
  // recalculate solution from current state
  solution=solveBoard([...state],SIZE);
  renderSolution();
  // pop animation
  const targets=[i];
  const r=Math.floor(i/SIZE),c=i%SIZE;
  if(r>0)targets.push(i-SIZE);
  if(r<SIZE-1)targets.push(i+SIZE);
  if(c>0)targets.push(i-1);
  if(c<SIZE-1)targets.push(i+1);
  targets.forEach(t=>{if(grid.children[t])grid.children[t].classList.add('pop')});
  // check win
  if(state.every(v=>!v)){
    puzzleSolved=true;
    document.getElementById('cardPuzzle').classList.add('solved');
    setTimeout(()=>go('scrFinal'),1200);
  }
}

document.getElementById('resetBtn').onclick=resetBoard;

/* ============ SOLUTION MAP ============ */
function renderSolution(){
  const sg=document.getElementById('solGrid');
  sg.style.gridTemplateColumns=`repeat(${SIZE},clamp(36px,11vw,48px))`;
  sg.innerHTML='';
  let stepNum=1;
  // sort solution for nice ordering (top-left to bottom-right)
  const sortedSol=[...solution].sort((a,b)=>a-b);
  for(let i=0;i<SIZE*SIZE;i++){
    const cell=document.createElement('div');
    cell.className='sol-cell';
    const isClick=sortedSol.includes(i);
    const isLit=state[i];
    if(isClick){
      cell.classList.add('click-me');
      cell.textContent=stepNum++;
      const clickIdx=i;
      cell.addEventListener('click',()=>{
        handleClick(clickIdx);
        cell.classList.add('done');
      });
    } else if(isLit){
      cell.classList.add('lit');
      cell.textContent='‚óè';
    } else {
      cell.classList.add('empty');
      cell.textContent='¬∑';
    }
    sg.appendChild(cell);
  }
}

/* ============ AUTO SOLVE ============ */
document.getElementById('btnAuto').onclick=function(){
  if(puzzleSolved)return;
  // get fresh solution from current state
  const steps=solveBoard([...state],SIZE).sort((a,b)=>a-b);
  let idx=0;
  const iv=setInterval(()=>{
    if(idx>=steps.length||puzzleSolved){clearInterval(iv);return}
    handleClick(steps[idx]);
    // mark done in solution grid
    const solCells=document.querySelectorAll('#solGrid .sol-cell.click-me');
    if(solCells[idx])solCells[idx].classList.add('done');
    idx++;
  },350);
};

initBoard();

/* ============ FINAL PORTAL ‚Üí CELEBRATION ============ */
document.getElementById('megaPortal').onclick=celebrate;
let celed=false;
function celebrate(){
  if(celed)return;celed=true;
  const f=document.createElement('div');
  f.style.cssText='position:fixed;inset:0;background:#fff;z-index:9997;animation:fO .8s ease forwards';
  document.head.insertAdjacentHTML('beforeend','<style>@keyframes fO{0%{opacity:1}100%{opacity:0}}</style>');
  document.body.appendChild(f);setTimeout(()=>f.remove(),900);
  setTimeout(()=>{document.getElementById('celeOverlay').classList.add('active');fireConfetti();fireBalloons();fireSparkles()},350);
}

function fireConfetti(){
  const cv=document.getElementById('confetti'),cx=cv.getContext('2d');cv.width=innerWidth;cv.height=innerHeight;
  const cols=['#ff6bca','#ffbe30','#5bffb0','#50aaff','#d080ff','#ff5050','#ff9500'];let bits=[];
  const count=Math.min(220,Math.floor(innerWidth*.4));
  for(let i=0;i<count;i++)bits.push({x:Math.random()*cv.width,y:Math.random()*cv.height-cv.height,w:Math.random()*9+4,h:Math.random()*5+3,c:cols[~~(Math.random()*cols.length)],sy:Math.random()*3+1.8,sx:(Math.random()-.5)*2,r:Math.random()*360,rs:(Math.random()-.5)*10,o:1});
  (function d(){cx.clearRect(0,0,cv.width,cv.height);let alive=false;bits.forEach(b=>{b.y+=b.sy;b.x+=b.sx;b.r+=b.rs;if(b.y>cv.height+20)b.o-=.015;if(b.o<=0)return;alive=true;cx.save();cx.translate(b.x,b.y);cx.rotate(b.r*Math.PI/180);cx.globalAlpha=b.o;cx.fillStyle=b.c;cx.fillRect(-b.w/2,-b.h/2,b.w,b.h);cx.restore()});if(alive)requestAnimationFrame(d)})();
}
function fireBalloons(){
  const em=['üéà','üéà','üéà','üéÅ','‚≠ê','üéà','üíú','üéà','üéà','üéà'];
  const total=Math.min(14,Math.floor(innerWidth/30));
  for(let i=0;i<total;i++)setTimeout(()=>{const b=document.createElement('div');b.className='balloon';b.textContent=em[i%em.length];b.style.left=Math.random()*88+6+'%';b.style.animationDuration=Math.random()*4+5+'s';document.body.appendChild(b);setTimeout(()=>b.remove(),11000)},i*300);
}
function fireSparkles(){
  const cols=['#ff6bca','#ffbe30','#5bffb0','#50aaff','#d080ff'];
  for(let i=0;i<40;i++)setTimeout(()=>{const s=document.createElement('div');s.className='sparkle';s.style.left=Math.random()*100+'%';s.style.top=Math.random()*100+'%';s.style.background=cols[~~(Math.random()*cols.length)];const sz=Math.random()*5+3;s.style.width=s.style.height=sz+'px';document.body.appendChild(s);setTimeout(()=>s.remove(),1200)},i*85);
}
</script>
</body>
</html>
